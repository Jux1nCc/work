# day06-mobile

## 概述

### 复习

判断频道区域：

+ 判断用户是否登录：
  + 如果登录：直接从服务器中得到用户的频道信息
  + 如果未登录：
    + 判断 localstorage 中是否存在频道数据
      + 如果存在，直接渲染到页面上
      + 如果不存在，从服务器中得到频道信息

给不同的频道之间设置不同的参数：

+ articleList：文章列表
+ loading：list 组件的加载状态
+ finished：list 组件数据是否加载完成
+ isLoading：pull-refresh 组件的刷新状态

渲染当前频道下的文章数据

+ 问题：
  + 接口：`/app/v1_1/articles`
  + 添加之后的文章数据不会显示出来
+ 补充：
  + 响应式数据
  + `this.$set`

频道操作面板

+ 将频道操作面板封装一个单独的组件
+ 完成结构与样式
+ 渲染了我的频道数据

### 今日内容

频道操作面板的完成

+ 频道推荐
+ 添加我的频道
+ 删除我的频道
+ 频道高亮

首页数据

更多操作

## 频道面板模块

### 频道面板 - 渲染频道推荐数据

> 强调：什么是频道推荐
>
> > 在黑马头条中有固定的频道数据，所谓的频道推荐指的就是所有频道数据中，除掉 我的频道数据的这部分数据

步骤：

+ a. 在打开页面时，请求服务器得到所有的频道数据
  + 请求服务器接口：**全部频道列表**
+ b. 将所有的频道数据保存起来
+ c. 从所有频道数据中将我的频道数据删除，得到一个新的数组就是频道推荐数据
  + 定义一个推荐频道的计算属性：在计算属性中将所有频道数据中的我的频道删除
+ d. 将频道推荐数据进行渲染

### 频道面板 - 计算属性的缓存问题

注意点：

+ 1.0 计算属性在第一次使用时会执行一次后的函数
+ 2.0 会将函数执行的结果进行缓存，再使用这个计算属性直接从缓存中取
+ 3.0 一旦计算属性中的依赖项发生改变，函数需要再次执行一次，会再将执行的结果再次进行缓存
+ 4.0 计算属性的缓存依赖项指的是：在计算属性中用到的 data 中的数据

### 频道面板 - 从一个数组中删除另一个数组中的所有元素

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

</body>
<script>
    // 问题：
    // // 我的频道数据
    var channelList = [
        {
            id: 0, name: '推荐', articleList: [], isLoading: false, loading: false, finished: false
        },
        {
            id: 2, name: 'c++', articleList: [], isLoading: false, loading: false, finished: false
        },
        {
            id: 4, name: 'js', articleList: [], isLoading: false, loading: false, finished: false
        },
    ]
    // 全部频道数据
    var allChannel = [
        { id: 0, name: '推荐' },
        { id: 1, name: '前端' },
        { id: 2, name: 'c++' },
        { id: 3, name: 'fontweb' },
        { id: 4, name: 'js' }
    ]
    // 在全部频道数据中将我的频道数据删除
    // 1.0 得到我的频道中的所有元素的 id 的集合
    // map 用来遍历数组，返回一个新的数组
    var ids = channelList.map(item => {
        return item.id
    })
    console.log(ids) // [0, 2, 4]
    // 2.0 遍历全部频道数据，判断全部频道数据中的 id 在 id 的集合中是否存在，如果存在不理会，如果不存在，就取出来
    // filter 用来遍历数组，返回一个新的满足条件的数组
    allChannel = allChannel.filter(item => {
        return !ids.includes(item.id)
    })
    console.log(allChannel)
</script>

</html>
```

注意点：

+ 必须熟练使用： `map & filter & includes`

### 频道面板 - 添加频道

步骤：

+ a. 给频道推荐下的每个频道数据添加一个点击事件
+ b. 得到被点击的元素，直接将元素添加到我的频道数据中
+ c. 将修改后的频道数据进行保存

  + 判断：用户是否登录：

    + 未登录：

      + 应该将操作后的频道数据保存到本地的：localstorage 中

    + 已登录：

      + 应该将操作后的频道数据保存到服务器中

        + 请求服务器的接口：（批量修改用户频道列表（重置式））
          + 参数： channels
            + 它是一数组：
            + 它的格式为： `[{id: 0, seq: 1}]`
            + id：频道的 id
            + seq：频道的排列顺序，默认从 1 开始
        
        + 注意点：
          + seq：默认从 1开始
          + 推荐数据不应该被操作，所以应该将推荐数据删除：可以使用 `slice`  删除
          + 删除之后， seq 从 2 开始
    
  + 接收返回数据

注意点：

+ 只要修改了我的频道，推荐会自动修改：

  + 推荐频道中有一个依赖项叫做我的频道
  + 一旦我的频道发生改变，推荐频道会再次重新生成

+ 提交到服务器接口的数据格式为 

  ```json
  {
  	channels: [
  		{ id: 0, seq: 1 }, // id 频道的 id, seq 频道的顺序(seq 是从 1 开始的)
  		{ id: 1, seq: 2 }  // 注意点：seq = 1 的位置永远是给推荐留着的
  	]
  }
  ```

### 频道面板 -  删除频道

步骤：

+ a. 给叉叉添加一个点击事件：
  + 将当前点击的频道数据从我的频道中删除
  + 将修改后的频道数据保存起来
    + 判断用户是否登录：
      + 未登录：
        + 将修改后的数据保存到 localstorage 中
      + 已登录：
        + 直接将数据提交到服务器

注意点：

+ 有个 bug：
  + 添加完频道之后，关闭频道操作面板，直接跳转到新增的频道中去无法获取文章数据

### 复习上午

渲染推荐频道数据

+ 计算属性
+ 从一个数组中删除另一个数组中的所有元素

添加频道

+ 将频道添加到我的频道中
+ 保存操作后的频道数据
  + 已登录：将操作后的频道数据保存到服务器中
  + 未登录：将操作后的频道数据保存到 localstorage 中

删除频道：

+ 将点击的频道数据进行删除
+ 保存操作后的频道数据
  + 已登录：将操作后的频道数据保存到服务器中
  + 未登录：将操作后的频道数据保存到 localstorage 中

### 频道面板 - 完成叉叉的隐藏

步骤：

+ 1.0 定义一个变量用来控制叉叉的显示和隐藏：isEdit
+ 2.0 通过变量来控制叉叉
+ 3.0 点击编辑时将：
  + isEdit 改为 true
  + 将完成按钮显示出来
+ 4.0 给完成按钮添加一个点击事件：
  + isEdit 改为 false
  + 将编辑按钮显示出来
+ 5.0 判断是否是推荐，如果是就将叉叉隐藏起来

### 频道面板 - 高亮选中频道

步骤：

+ 1.0 在频道操作面板中添加字体变红的样式
+ 2.0 将首页中选中的频道的下标传入到频道面板中
+ 3.0 在频道面板中接收属性
+ 4.0 根据接收到的属性设置选中的颜色
+ 5.0 给频道面板中的频道选项添加点击事件：
  + 要将 active 改为当前点击的频道的下标

注意点：

+ 如果直接在频道操作面板中修改父组件中传入的  `active` 属性会报错：

  + 错误产生的原因：单向数据流（父组件通过 props 传入到子组件中的数据不允许在子组件中进行修改）

  + 解决方案：
    + 不应该让子组件去修改这个数据，应该将数据从子组件中传入到父组件中，在父组件中进行修改就OKEY了

### 频道面板 - .sync 改造代码

> 回顾：
>
> > v-model 的特点：
> >
> > > 双向数据绑定
> >
> > v-model 绑定的原因：
> >
> > > 向组件内传入一个键为 ： value 值
> > >
> > > 接收组件传回的参数，事件名为： input 
> >
> > 由于 v-model 在使用时，
> >
> > > 必须保存传入的键为： value
> > >
> > > 必须保证传回的事件名为： input
> >
> > 为了解决这样的问题：我们可以使用 .sync 来解决这个问题

作用：.sync 的作用与 v-model 一样也可以让数据与组件进行双向绑定

用法：

+ v-model：双向绑定数据

  + 父组件：

    ```html
    <son v-model="msg"></son>
    1.0 向子组件中传入一个参数： value，值为 msg
    2.0 从子组件中接收一个事件： input
    ```

  + 子组件

    ```
    1.0 接收参数: props=['value']
    2.0 传出参数： $emit('input', msg)
    ```

+ .sync ：双向绑定

  + 父组件：

    ```html
    <son active.sync="active" ></son>
    1.0 向子组件中传入一个参数： active，值为 active
    2.0 从子组件中接收一个事件： update:active
    ```

  + 子组件：

    ```
    1.0 接收参数： props = ['active']
    2.0 传出参数： $emit('update:active', active)
    ```

注意点：

+ 由于事件冒泡：点击叉叉后还会触发宫格的点击事件，需要使用事件修饰符 `.stop`

## 首页数据

### 首页数据 - 完成数据的结构 & 样式

+ 文章数组的组成：
  + 文章的标题
  + 文章的图片
    + 可以使用 vant 中的组件： 
  + 文章的作者 & 评论数 & 发布日期    更多操作按钮

### 首页数据 - 动态渲染数据

> 了解文章数据源中的数据：
>
> > art_id：文章的 id
> >
> > aut_id：作者的 id
> >
> > aut_name ：作者的名称
> >
> > ch_id：所属频道的 id
> >
> > collect_count：收藏数
> >
> > comm_count：评论数
> >
> > cover：文章的图片信息
> >
> > > images：数组，保存图片的路径
> > >
> > > type：当前文章的图片的数量（0，1，3）
> >
> > is_top：是否处于置顶状态
> >
> > like_count：点赞数
> >
> > pubdate：发布日期
> >
> > title：文章的标题

### 首页数据 - 实现图片懒加载

> 为什么要实现懒加载：
>
> > 1.0 因为网速的原因：如果一次性将图片全部加载出来，网络差一点，页面打开非常慢
> >
> > 2.0 因为是移动端：如果加载出来的图片用户看不到，就没有意义，浪费流量。

使用 lazy-load 指令来实现懒加载

步骤：

+ 1.0 给图片设置一个指令 `lazy-load`

+ 2.0 向 vue 中注册这个 `lazy-load` 指令

  ```js
  import Vue from 'vue'
  import { Lazyload } from 'vant'
  Vue.use(Lazyload)
  ```

### 首页数据 - dayjs 的使用

> 将具体时间改为相对时间（可以使用一个第三方包： dayjs （与 Moment.js 的用户基本一致））

[dayjs](https://github.com/iamkun/dayjs/blob/dev/docs/zh-cn/README.zh-CN.md)：

+ 作用：与 moment.js 一样，可以用来进行时间处理

+ 特点：

  + 用法与 moment.js 一样
  + 大小比 moment.js 要小得多，只有 2 kb 
  + dayjs 的 API 设置与 moment.js 完全一样 

+ 使用步骤：

  + 1.0 安装第三方包：`npm install dayjs --save`

  + 2.0 导入 `dayjs` ： `import dayjs from 'dayjs'`

  + 3.0 调用 API： `dayjs().fromat('YYYY-MM-DD hh:mm:ss')`

  + 4.0 使用 dayjs 的相对时间插件

    ```js
    // 导入相对时间的插件
    import relativeTime from 'dayjs/plugin/relativeTime'
    // 将插件使用到 dayjs 中
    dayjs.extend(relativeTime)
    // 得到相对时间
    var time = dayjs().from(dayjs('1990'))
    console.log(time) // 30 年以前
    ```

  + 5.0 使用 dayjs 中的语言包

    ```js
    // 导入中文语言包
    import 'dayjs/locale/zh-cn'
    // 全局使用语言包
    dayjs.locale('zh-cn')
    ```

### 首页数据 - 修改时间

> 思路：将 dayjs 封装为一个过滤器，在要修改时间的位置使用一下就可以了
>
> 复习过滤器：
>
> > 定义过滤器: `Vue.filter('myfilter', function(value) { return xxx })`
> >
> > 使用过滤器：`{{ msg | myfilter }}`

步骤：

+ 1.0 在 `src` 目录下创建一个 `filter` 文件夹
+ 2.0 在 `filter` 下面添加一个文件： `myfilter.js`
+ 3.0 在文件中定义一个过滤器：
  + 使用 `dayjs` 将时间进行处理
+ 4.0 在 `main.js` 使用这个过滤器
+ 5.0 在需要的地方使用这个过滤器

## 更多操作

### 更多操作 - 将面板封装为一个组件

步骤：

+ 1.0 在 `index/com` 中创建一个文件： `more.vue`
+ 2.0 在 `more.vue` 中完成结构
+ 3.0 给更多操作按钮添加一个点击事件：
  + 在事件中修改控制 `more.vue` 显示和隐藏的属性

### 更多操作 - 不感兴趣

步骤：

+ 1.0 打开更多操作面板时：
  + 记录当前点击的文章数据的 id
+ 将文章的 id 传入到更多面板中
+ 2.0 在更多操作面板中接收文章的 id
+ 3.0 给不感兴趣添加点击事件：
  + 将 id 对应的文章从页面上删除
    + 将 id 传回到首页中
    + 在首页中根据 id 将文章对应的数据进行删除
  + 将 id 对应的文章提交到服务器标记为 `不喜欢`
    + 请求服务器接口：对文章不喜欢

注意点：

+ 1.0 如果要对文章不感兴趣，必须用户已经登录：
  + 如果没有登录报的错误是： `User must be authorized`
  + 错误的状态： `401`
+ 2.0 登录之后还是会报一个 ` 400 ` 的错误
  + 报错信息是： ` Invalid target article id ` (无效的文章 id)
  + 错误的状态： `400`

### 更多操作 - 分析错误

错误的提示信息：无效的文章 id

错误的原因：

+ 由于黑马头条中的新闻信息非常多

+ 在存储这些信息时，会给这些信息设置一个唯一的标识的 `art_id`

+ `art_id`: 它是一个 Number 类型的数据，存储在服务器中

+ 将来这个 `art_id` 会在请求数据时，返回给浏览器：

  + 浏览器中有一个 `bug`：处理数字时是有范围的最大值最多为 `9007199254740992`

  + 由于新闻数据非常多：`art_id` 已经远远超过了 js 处理的最大数字 
  + js 在遇到比它处理范围要大的数字时，会偷懒：
    + 丢失精度

总结：

+ 由于新闻的 id 太长，超过了浏览器中 js 的处理范围，造成了 id 精度的丢失。页面最终报错

### 更多操作 - 解决数字超过 js 的处理范围

> 如果要解决以上问题：可以使用第三方 [json-bigint](https://github.com/sidorares/json-bigint)

步骤：

+ 1.0 下载 `json-bigint`

+ 2.0 在 `http.js` 中导入 `jsonbigint`

+ 3.0 在接收响应信息的位置将转换的代码从 `JSON.parse` 改为 `jsonbigint.parse`
  + 在 `transformResponse` 中添加一个响应信息的转换代码

+ 4.0 给 `jsonbig.parse` 添加一个 `try-catch` 防止将来响应的数据为空时，代码报错

### 更多操作 - 反馈垃圾内容

步骤：

+ 1.0 在更多操作面板中添加另一个 van-cell-group
+ 2.0 给反馈垃圾内容添加一个点击事件
  + 在事件中将举报详情显示出来： isReport 设置为 true
+ 3.0 在举报详情中添加一个向左的箭头
  + 给箭头添加一个点击事件：在事件中将  isReport 设置为 false
+ 4.0 给每个举报选项添加一个点击事件
  + 得到当前要举报的文章的 id
  + 得到当前要举报的类型 id
  + 发送请求到服务器举报文章
  + 添加举报的提示框
  + 将面板切换到不感兴趣结构
  + 关闭面板

### 更多操作 - 拉黑作者

### 补充：

+ http 协议：
  + 请求的 url：
    +  `https://www.baidu.com:8080/p/a/t/h?query=string#hash`
    + 协议://域名:端口号/请求的路径?参数名=参数值&参数名=参数值#hash值
  + 请求报文
    + 请求报文行
    + 请求报文头
    + 请求报文体
  + 响应报文
    + 响应报文行
    + 响应报文头
    + 响应报文体
  + 请求方式
    + GET
      + 特点：将参数放到请求的 url 中
      + 侧重于从服务器中得到数据
    + POST
      + 特点：将参数放到请求体中
      + 侧重于提交数据到服务器
    + PUT
      + 特点：将参数放到请求体中（与 post 类似）
      + 侧重于修改服务器的数据
    + DELETE
      + 特点： 将参数放到 url 中（与 GET 类似）
      + 侧重于删除服务器中的数据
    + 类假的请求方式其实有很多：
      + 但是我们平时做开始时，一般只会用到 GET & POST