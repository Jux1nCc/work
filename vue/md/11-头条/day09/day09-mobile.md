# day09-mobile

## 概述

### 复习

搜索：

+ 关键字高亮
+ 判断搜索内容是否为空
+ js 的来抖动
  + 防抖
  + 节流
+ 保存搜索历史
+ 获取搜索历史
+ 渲染搜索历史
+ 搜索历史的排序与去重
+ 删除搜索历史
+ 清空搜索历史

搜索结果：

+ 完成静态页面
+ 完成数据的动态获取

### 今日内容

搜索结果：

+ 上拉加载更多

登录判断：

+ 封装一个登录验证的方法
+ 登录验证之后返回到登录之前的页面
+ token 失效的处理方式

详情页面：

+ 完成静态页面
+ 渲染数据
+ 完成其它功能

##  搜索结果

### 搜索结果 - 完成上拉加载更多

步骤：

+ 1.0 在 onload 中将 list 的组件的加载状态设置为 false
+ 2.0 将得到的数据源进行拼接，而不是覆盖
+ 3.0 在 onload 中每次进行让 page 加 1
+ 4.0 判断返回的结果是否为空

## 判断登录

### 判断登录 - 直接在评论按钮中完成登录判断

步骤：

+ a. 给评论按钮添加一个点击事件
  + 在事件中判断用户是否登录：判断 $store 中是否存在 token	
    + 用户登录：执行后续的逻辑代码（也就打印：评论功能）
    + 用户未登录：跳转到登录页面进行登录

### 判断登录 - 将登录验证封装为一个全局方法

> 如果将登录验证的方法直接写到逻辑代码中，将来重用不太方便，我们可以尝试将登录验证的代码封装为一个 `vue` 的全局方法

步骤：

+ a. 在 main.js 中向 Vue 的 prototype 中添加一个 $login 方法
  + 在方法中完成登录的验证
+ b. 在点赞按钮中通过: this.$login 方法来验证登录

### 判断登录 - 插件的使用

> $login 方法如果直接放到 main.js 中会造成 main.js 中的逻辑代码过多，代码结构不够清晰
>
> 可以将 $login 方法封装为 vue 的一个插件：以此来将方法提取到其它文件中，保证 main.js 代码的单一性

基本概念：

+  插件通常用来为 Vue 添加全局功能 。一般在使用插件时都使用 `Vue.use(xxx)`

封装插件：

+ 使用插件：

  ```js
  // 调用 `MyPlugin.install(Vue)`
  Vue.use(MyPlugin)
  
  new Vue({
    // ...组件选项
  })
  ```

+ 创建插件：

  ```js
  // 定义一个插件对象
  var pluginObj = {}
  // 给插件对象添加一个 `install` 方法
  pluginObj.install = function (Vue) {
  	// 可以给 Vue 添加一些全局的方法了
  }
  // 将插件对象暴露出去
  export default pluginObj
  ```

注意点：

+ 使用插件：
  + 插件的使用代码必须放到创建 `vue` 实例之前
  + 使用 `use` 方法来使用插件
  + `use` 方法其实相当于是调用插件的 `install` 方法
+ 创建插件：
  + 插件必须有一个方法 install 方法
  + 这个 install 方法有一个参数： vue 构造器

### 判断登录 - 将登录验证方法封装为一个插件

步骤：

+ a. 在 utils 下面创建一个文件： `myplugin.js`
+ b. 在文件中：
  + 创建一个对象
  + 给对象添加一个 install 方法
  + 在 install 方法中给  `Vue` 添加一个 `$login` 方法
  + 导出这个对象
+ c. 在 `main.js` 中导入这个文件
+ d. 通过 `Vue.use` 来使用这个插件

### 判断登录 -  登录成功后回退到登录之前的页面

> 问题：
>
> > 登录页面需要有两个逻辑：
> >
> > > 如果是验证登录：应该返回到登录之前的页面
> > >
> > > 如果是正常登录：应该跳转到首页
>
> 解决方案：
>
> > 给登录页面设置两个路由：
> >
> > > checklogin：用来单独处理验证登录
> > >
> > > login：用来进行正常登录

步骤：

+ a. 在 router 中给 login 组件再添加一个路由 checklogin
+ b. 在 login 组件的 login 方法中在登录成功之后的代码中添加判断：
  + 得到当前页面的路由
    + this.$route.path
  + 判断当前页面的路由
    + 如果路由名为 checkLogin ：就需要回退到上一个页面
      + 调用： this.$router.back()
    + 如果路由名为 login ： 就需要跳转到首页
      + 调用： this.$router.push('/home')
+ c. 在验证验证的 $login 方法中，如果判断出用户没有登录，应该跳转到 /checkLogin 中

### 复习上午

搜索结果：

+ 完成数据的上拉加载更多

判断登录：

+ 直接完成登录验证逻辑
+ 将登录验证逻辑封装为一个全局方法
+ 将登录验证逻辑封装为一个插件

+ 概念：
  + vue 全家桶：vue & vue-cli & vue-router & vuex & axios & dev-tool
+ 登录成功之后回退到之前的页面

### 判断登录 - token 失效的处理方式

> 问题：
>
> > token 有一个特点：会隔两个小时会过期一次，一旦 token 过期将来服务器请求的接口中如果携带了 token 服务器就会响应 401 的错误信息
>
> 解决方案：
>
> > 可以使用 refresh_token 来解决以上问题
> >
> > 来源：当我们在登录页面进行登录时，服务器会返回一个对象，对象中有两个属性： token & refresh_token
> >
> > token：时效两个小时。用来保存用户的登录信息
> >
> > refresh_token：时效14天。当 token 失效时，可以使用 refresh_token 去服务器中更新 token

步骤：

+ a. 先捕获到当前请求的错误信息
+ b. 判断当前请求的错误信息是否是 401，如果是 401 说明 token 过期了
+ c. 将 refresh_token 重新提交到服务器得到新的 token
+ d. 用新的 token 将过期的 token 覆盖掉
+ e. 继续完成未完成的请求

注意点：

+ 响应回来的错误信息时包含以下属性：
  + config：发送错误请求的所有的配置信息
  + request：当前发送错误请求相关的请求信息
  + response：当前发送错误请求相关的响应信息
    +  status ：响应回来的状态码

## 详情页面

### 详情页面 - 完成静态页面

+ 创建组件 & 设置路由
+ 设置入口
+ 完成结构 & 样式
  + 头部标题
  + 文章标题
  + 作者信息
  + 文章内容
  + 点赞 & 不喜欢区域
  + 评论区域
    + 将单条评论封装为一个单独的组件
      + 步骤：
        + 1.0 在 detail 中创建一个文件夹：com
        + 2.0 在 com 添加一个 comment.vue 组件
        + 3.0 在 detail 页面中使用这个组件
        + 4.0 完成静态的结构 & 样式
  + 评论书写区域
    + 将评论书写区域封装为一个组件
      + 步骤
        + 1.0 在 com 添加一个 write.vue 组件
        + 2.0 在 detail 页面中使用这个组件
        + 3.0 完成静态的结构 & 样式

### 详情页面 - 渲染文章数据

步骤：

+ 1.0 打开页面时先根据文章的 id 得到文章的详情
+ 2.0 将详情渲染到页面上

### 详情页面 - 关注作者

步骤：

+ a. 给关注按钮添加一个点击事件
+ b. 在事件中：
  + 得到当前文章作者的 id
  + 将 id 提交到服务器，关注作者
    + 请求服务器接口（关注用户）
  + 手动将用户的关注状态设置为 true

### 详情页面 - 取关作者

步骤：

+ a. 给已关注按钮添加一个点击事件
+ b. 在事件中：
  + 得到当前文章作者的 id
  + 将 id 提交到服务器，取消关注作者
    + 请求服务器接口（取消关注用户）
      + url： /user/followings/:target 
      + method： DELETE 
      + 参数：
        + 路径 参数（写在路由上的）
          + target：作者的 id
      + 返回数据
  + 手动将用户的关注状态设置为 false

### 详情页面 - 点赞

步骤：

+ a. 给点赞（默认样式）按钮添加一个点击事件：
+ b. 在事件中：
  + 得到文章的 id
  + 将文章 Id 提交到服务器，对文章进行点赞
    + 请求服务器的接口（对文章点赞）
  + 手动将文章的 态度 属性设置为 1

### 详情页面 - 取消点赞

步骤：

+ a. 给点赞（红色）按钮添加一个点击事件：
+ b. 在事件中：
  + 得到文章的 id
  + 将文章 Id 提交到服务器，对文章进行取消点赞
    + 请求服务器的接口（取消对文章点赞）
  + 手动将文章的 态度 属性设置为 -1

### 详情页面 - 不喜欢

### 详情页面 - 取消不喜欢

### 详情页面 - 渲染评论数据

步骤：

+ a. 在页面上添加一个 list 组件，用来包裹评论信息

+ b. 在 list 组件的 onload 事件中来请求当前文章对应的评论数据

  + 请求服务器接口（获取评论或评论回复）

+ c. 将数据进行渲染

  + 在遍历生成评论数据时，应该将数据替换为 commentList
  + 将遍历出来的数据传入到评论组件的内部（父传子）
  + 在评论组件内部接收数据
  + 在评论组件内部渲染数据

+ d. 实现上拉加载更多操作

+ e. 判断数据是否加载完成功能

### 详情页面 - 完成添加评论

步骤：

+ 1.0 在 write 组件中的输入框中输入内容
+ 2.0 得到输入框中的内容，将内容提交到服务器
+ 3.0 接收服务器响应的数据（本次添加的评论数据）
+ 4.0 将新的评论数据渲染到页面上

### 详情页面 - 封装评论回复的面板

### 详情页面 - 显示当前点击的评论数据

### 详情页面 - 渲染文章评论的回复

### 详情页面 - 完成评论的回复